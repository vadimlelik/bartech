# ๐ ะัะพะฒะตัะบะฐ ัะฐะฑะพัั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั SSL ัะตััะธัะธะบะฐัะพะฒ

## โ ะงัะพ ะฑัะปะพ ะธัะฟัะฐะฒะปะตะฝะพ

1. **ะฃััะฐะฝะพะฒะบะฐ Docker CLI ะฒ ะบะพะฝัะตะนะฝะตั certbot** - ัะตะฟะตัั ะบะพะฝัะตะนะฝะตั ะผะพะถะตั ะฟะตัะตะทะฐะณััะถะฐัั Nginx ะฟะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธั ัะตััะธัะธะบะฐัะพะฒ
2. **ะฃะปัััะตะฝ ัะบัะธะฟั ะฟะตัะตะทะฐะณััะทะบะธ Nginx** - ะดะพะฑะฐะฒะปะตะฝะฐ ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะธ ะธะฝัะพัะผะฐัะธะฒะฝัะต ัะพะพะฑัะตะฝะธั

---

## ๐ ะะฐะบ ะฟัะพะฒะตัะธัั, ััะพ ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ัะฐะฑะพัะฐะตั

### 1. ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะบะพะฝัะตะนะฝะตัะฐ certbot

```bash
# ะะฐ ัะตัะฒะตัะต
cd /opt/bartech
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps certbot
```

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
```
NAME              STATUS          PORTS
bartech-certbot   Up X minutes     ...
```

### 2. ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ certbot

```bash
# ะะพัะปะตะดะฝะธะต ะปะพะณะธ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50 certbot

# ะะพะณะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f certbot
```

**ะงัะพ ะธัะบะฐัั ะฒ ะปะพะณะฐั:**
- `ะัะพะฒะตัะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั SSL ัะตััะธัะธะบะฐัะพะฒ...` - ะบะฐะถะดัะต 12 ัะฐัะพะฒ
- `ะัะพะฒะตัะบะฐ ะทะฐะฒะตััะตะฝะฐ` - ะฟะพัะปะต ะฟัะพะฒะตัะบะธ
- `ะกะตััะธัะธะบะฐัั ะพะฑะฝะพะฒะปะตะฝั. ะะตัะตะทะฐะณััะทะบะฐ Nginx...` - ะตัะปะธ ัะตััะธัะธะบะฐัั ะฑัะปะธ ะพะฑะฝะพะฒะปะตะฝั
- `โ Nginx ััะฟะตัะฝะพ ะฟะตัะตะทะฐะณััะถะตะฝ` - ะฟะพัะปะต ััะฟะตัะฝะพะน ะฟะตัะตะทะฐะณััะทะบะธ

### 3. ะัะพะฒะตัะบะฐ ะดะฐัั ะธััะตัะตะฝะธั ัะตััะธัะธะบะฐัะพะฒ

```bash
# ะัะพะฒะตัะบะฐ ัะตััะธัะธะบะฐัะพะฒ ะฝะฐ ัะตัะฒะตัะต
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec certbot certbot certificates
```

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
```
Found the following certs:
  Certificate Name: technobar.by
    Domains: technobar.by *.technobar.by
    Expiry Date: YYYY-MM-DD HH:MM:SS+00:00 (VALID: XX days)
    Certificate Path: /etc/letsencrypt/live/technobar.by/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/technobar.by/privkey.pem
```

**ะะฐะถะฝะพ:** ะกะตััะธัะธะบะฐัั ะพะฑะฝะพะฒะปััััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐ 30 ะดะฝะตะน ะดะพ ะธััะตัะตะฝะธั.

### 4. ะัะพะฒะตัะบะฐ ัะตัะตะท ะฒะตะฑ-ะธะฝัะตััะตะนั

ะัะบัะพะนัะต ะฒะฐั ัะฐะนั ะฒ ะฑัะฐัะทะตัะต ะธ ะฟัะพะฒะตัััะต ัะตััะธัะธะบะฐั:
- Chrome/Edge: ะะฐะถะผะธัะต ะฝะฐ ะทะฐะผะพะบ โ "ะกะตััะธัะธะบะฐั" โ ะฟัะพะฒะตัััะต "ะะตะนััะฒะธัะตะปะตะฝ ะดะพ"
- Firefox: ะะฐะถะผะธัะต ะฝะฐ ะทะฐะผะพะบ โ "ะะพะดัะพะฑะฝะตะต" โ "ะัะพัะผะพัั ัะตััะธัะธะบะฐัะฐ"

### 5. ะััะฝะพะน ัะตัั ะพะฑะฝะพะฒะปะตะฝะธั

ะะปั ะฟัะพะฒะตัะบะธ, ััะพ ะผะตัะฐะฝะธะทะผ ะพะฑะฝะพะฒะปะตะฝะธั ัะฐะฑะพัะฐะตั:

```bash
# ะัะธะฝัะดะธัะตะปัะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต (ะดะฐะถะต ะตัะปะธ ัะตััะธัะธะบะฐัั ะตัะต ะดะตะนััะฒะธัะตะปัะฝั)
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec certbot certbot renew \
  --dns-cloudflare \
  --dns-cloudflare-credentials /cloudflare.ini \
  --force-renewal \
  --post-hook "/reload-nginx.sh"
```

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
- ะกะตััะธัะธะบะฐัั ะฑัะดัั ะพะฑะฝะพะฒะปะตะฝั
- Nginx ะฑัะดะตั ะฟะตัะตะทะฐะณััะถะตะฝ
- ะ ะปะพะณะฐั ะฟะพัะฒะธััั ัะพะพะฑัะตะฝะธะต ะพะฑ ััะฟะตัะฝะพะน ะฟะตัะตะทะฐะณััะทะบะต

---

## โ๏ธ ะะฐะบ ัะฐะฑะพัะฐะตั ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต

### ะะฐัะฟะธัะฐะฝะธะต

1. **ะะพะฝัะตะนะฝะตั certbot ะทะฐะฟััะบะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ** ะฟัะธ ััะฐััะต docker-compose
2. **ะัะพะฒะตัะบะฐ ะบะฐะถะดัะต 12 ัะฐัะพะฒ** - ะบะพะฝัะตะนะฝะตั ะฟัะพะฒะตััะตั ะฝะตะพะฑัะพะดะธะผะพััั ะพะฑะฝะพะฒะปะตะฝะธั
3. **ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต** - ะตัะปะธ ัะตััะธัะธะบะฐัั ะธััะตะบะฐัั ัะตัะตะท 30 ะดะฝะตะน ะธะปะธ ะผะตะฝััะต
4. **ะะฒัะพะผะฐัะธัะตัะบะฐั ะฟะตัะตะทะฐะณััะทะบะฐ Nginx** - ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั

### ะัะพัะตัั ะพะฑะฝะพะฒะปะตะฝะธั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะพะฝัะตะนะฝะตั certbot ะทะฐะฟััะตะฝ              โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะฐะถะดัะต 12 ัะฐัะพะฒ:                       โ
โ  /auto-renew-certs.sh                   โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  certbot renew --quiet                  โ
โ  (ะฟัะพะฒะตััะตั ะฝะตะพะฑัะพะดะธะผะพััั ะพะฑะฝะพะฒะปะตะฝะธั)   โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
        โโโโโโโโดโโโโโโโ
        โ             โ
    ะะฑะฝะพะฒะปะตะฝะธะต   ะะตั ะพะฑะฝะพะฒะปะตะฝะธั
    ะฝะตะพะฑัะพะดะธะผะพ   (ัะตััะธัะธะบะฐัั ัะฒะตะถะธะต)
        โ             โ
        โผ             โผ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ ะะฑะฝะพะฒะปะตะฝะธะต   โ  โ ะะฐะฒะตััะตะฝะธะต   โ
โ ัะตััะธัะธะบะฐัะพะฒ โ  โ ะฟัะพะฒะตัะบะธ     โ
โโโโโโโโฌโโโโโโโโ  โโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  post-hook: /reload-nginx.sh             โ
โ  (ะฟะตัะตะทะฐะณััะทะบะฐ Nginx)                    โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Nginx ะฟะตัะตะทะฐะณััะถะตะฝ                  โ
โ  โ ะะพะฒัะต ัะตััะธัะธะบะฐัั ะฐะบัะธะฒะฝั           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ง ะฃัััะฐะฝะตะฝะธะต ะฟัะพะฑะปะตะผ

### ะัะพะฑะปะตะผะฐ: ะะพะฝัะตะนะฝะตั certbot ะฝะต ะทะฐะฟััะบะฐะตััั

**ะะตัะตะฝะธะต:**
```bash
# ะัะพะฒะตัััะต ะปะพะณะธ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs certbot

# ะัะพะฒะตัััะต, ััะพ volumes ัะพะทะดะฐะฝั
docker volume ls | grep technobar

# ะะตัะตะทะฐะฟัััะธัะต ะบะพะฝัะตะนะฝะตั
docker-compose -f docker-compose.yml -f docker-compose.prod.yml restart certbot
```

### ะัะพะฑะปะตะผะฐ: ะกะตััะธัะธะบะฐัั ะฝะต ะพะฑะฝะพะฒะปััััั

**ะัะธัะธะฝั ะธ ัะตัะตะฝะธั:**

1. **ะะตะฟัะฐะฒะธะปัะฝัะต ััะตัะฝัะต ะดะฐะฝะฝัะต Cloudflare:**
   ```bash
   # ะัะพะฒะตัััะต ัะฐะนะป cloudflare.ini
   cat certbot/cloudflare.ini
   # ะะพะปะถะตะฝ ัะพะดะตัะถะฐัั: dns_cloudflare_api_token = ะฒะฐั_ัะพะบะตะฝ
   ```

2. **ะกะตััะธัะธะบะฐัั ะตัะต ะฝะต ััะตะฑััั ะพะฑะฝะพะฒะปะตะฝะธั:**
   - Certbot ะพะฑะฝะพะฒะปัะตั ัะตััะธัะธะบะฐัั ัะพะปัะบะพ ะทะฐ 30 ะดะฝะตะน ะดะพ ะธััะตัะตะฝะธั
   - ะญัะพ ะฝะพัะผะฐะปัะฝะพะต ะฟะพะฒะตะดะตะฝะธะต

3. **ะัะพะฒะตัััะต ะปะพะณะธ:**
   ```bash
   docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs certbot | grep -i error
   ```

### ะัะพะฑะปะตะผะฐ: Nginx ะฝะต ะฟะตัะตะทะฐะณััะถะฐะตััั ะฟะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธั

**ะะตัะตะฝะธะต:**
```bash
# ะัะพะฒะตัััะต, ััะพ docker CLI ัััะฐะฝะพะฒะปะตะฝ ะฒ ะบะพะฝัะตะนะฝะตัะต
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec certbot docker --version

# ะัะปะธ docker ะฝะต ะฝะฐะนะดะตะฝ, ะฟะตัะตะทะฐะฟัััะธัะต ะบะพะฝัะตะนะฝะตั (docker-cli ัััะฐะฝะพะฒะธััั ะฐะฒัะพะผะฐัะธัะตัะบะธ)
docker-compose -f docker-compose.yml -f docker-compose.prod.yml restart certbot

# ะะตัะตะทะฐะณััะทะธัะต Nginx ะฒัััะฝัั
docker exec bartech-nginx nginx -s reload
```

### ะัะพะฑะปะตะผะฐ: ะัะธะฑะบะฐ "Permission denied" ะฟัะธ ะดะพัััะฟะต ะบ docker.sock

**ะะตัะตะฝะธะต:**
```bash
# ะัะพะฒะตัััะต ะฟัะฐะฒะฐ ะฝะฐ docker.sock
ls -la /var/run/docker.sock

# ะฃะฑะตะดะธัะตัั, ััะพ ะบะพะฝัะตะนะฝะตั ะธะผะตะตั ะดะพัััะฟ (ะดะพะปะถะฝะพ ะฑััั :ro ะฒ docker-compose.yml)
grep docker.sock docker-compose.yml
```

---

## ๐ ะะพะฝะธัะพัะธะฝะณ

### ะะฐัััะพะนะบะฐ ะผะพะฝะธัะพัะธะฝะณะฐ ะพะฑะฝะพะฒะปะตะฝะธะน

ะั ะผะพะถะตัะต ะฝะฐัััะพะธัั ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฟัะพะฑะปะตะผะฐั ั ัะตััะธัะธะบะฐัะฐะผะธ:

```bash
# ะกะบัะธะฟั ะดะปั ะฟัะพะฒะตัะบะธ ััะพะบะฐ ะดะตะนััะฒะธั ัะตััะธัะธะบะฐัะพะฒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec certbot \
  certbot certificates | grep "Expiry Date"
```

### ะัะพะฒะตัะบะฐ ัะตัะตะท cron (ะพะฟัะธะพะฝะฐะปัะฝะพ)

ะัะปะธ ัะพัะธัะต ะดะพะฟะพะปะฝะธัะตะปัะฝะพ ะฟัะพะฒะตัััั ัะตััะธัะธะบะฐัั:

```bash
# ะะพะฑะฐะฒััะต ะฒ crontab ะฝะฐ ัะตัะฒะตัะต
0 0 * * * cd /opt/bartech && docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T certbot certbot certificates | grep -q "VALID" || echo "โ๏ธ ะัะพะฒะตัััะต ัะตััะธัะธะบะฐัั!"
```

---

## โ ะงะตะบะปะธัั ะฟัะพะฒะตัะบะธ

ะะพัะปะต ะฝะฐัััะพะนะบะธ ัะฑะตะดะธัะตัั, ััะพ:

- [ ] ะะพะฝัะตะนะฝะตั `bartech-certbot` ะทะฐะฟััะตะฝ ะธ ัะฐะฑะพัะฐะตั
- [ ] ะ ะปะพะณะฐั certbot ะฒะธะดะฝั ัะตะณัะปััะฝัะต ะฟัะพะฒะตัะบะธ (ะบะฐะถะดัะต 12 ัะฐัะพะฒ)
- [ ] ะคะฐะนะป `certbot/cloudflare.ini` ัะพะดะตัะถะธั ะฟัะฐะฒะธะปัะฝัะน API ัะพะบะตะฝ
- [ ] Docker volumes `technobar_certbot-etc` ะธ `technobar_certbot-var` ัะพะทะดะฐะฝั
- [ ] ะกะตััะธัะธะบะฐัั ัััะตััะฒััั ะธ ะดะตะนััะฒะธัะตะปัะฝั
- [ ] Nginx ััะฟะตัะฝะพ ะฟะตัะตะทะฐะณััะถะฐะตััั ะฟะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธั (ะฟัะพะฒะตัััะต ะปะพะณะธ)
- [ ] Docker CLI ะดะพัััะฟะตะฝ ะฒ ะบะพะฝัะตะนะฝะตัะต certbot

---

## ๐ฏ ะัะพะณ

ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ัะตััะธัะธะบะฐัะพะฒ ะดะพะปะถะฝะพ ัะฐะฑะพัะฐัั "ะธะท ะบะพัะพะฑะบะธ" ะฟะพัะปะต ะฟัะฐะฒะธะปัะฝะพะน ะฝะฐัััะพะนะบะธ:

1. โ ะะพะฝัะตะนะฝะตั certbot ะทะฐะฟััะบะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
2. โ ะัะพะฒะตััะตั ัะตััะธัะธะบะฐัั ะบะฐะถะดัะต 12 ัะฐัะพะฒ
3. โ ะะฑะฝะพะฒะปัะตั ะทะฐ 30 ะดะฝะตะน ะดะพ ะธััะตัะตะฝะธั
4. โ ะะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะทะฐะณััะถะฐะตั Nginx

**ะัะปะธ ััะพ-ัะพ ะฝะต ัะฐะฑะพัะฐะตั:**
- ะัะพะฒะตัััะต ะปะพะณะธ: `docker-compose logs certbot`
- ะัะพะฒะตัััะต ััะฐััั ะบะพะฝัะตะนะฝะตัะฐ: `docker-compose ps`
- ะัะพะฒะตัััะต ัะตััะธัะธะบะฐัั: `docker-compose exec certbot certbot certificates`


