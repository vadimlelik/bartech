name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh "$SSH_USER@$SERVER_HOST" << 'EOF'
            set -e
            cd /opt/bartech
            
            # Проверка наличия .env файла
            if [ ! -f .env ]; then
              echo "ERROR: .env file not found!"
              exit 1
            fi
            
            # Создание Docker volumes, если их нет
            echo "Checking Docker volumes..."
            if ! docker volume ls | grep -q "technobar_certbot-etc"; then
              echo "Creating volume technobar_certbot-etc..."
              docker volume create technobar_certbot-etc
            fi
            if ! docker volume ls | grep -q "technobar_certbot-var"; then
              echo "Creating volume technobar_certbot-var..."
              docker volume create technobar_certbot-var
            fi
            echo "Volumes ready"
            
            # Загрузка переменных из .env файла (безопасный способ)
            # Используем цикл для правильной обработки всех строк, включая значения с пробелами
            echo "Loading environment variables from .env file..."
            set -a
            loaded_count=0
            while IFS= read -r line || [ -n "$line" ]; do
              # Пропускаем комментарии и пустые строки
              case "$line" in
                \#*|'') continue ;;
              esac
              # Удаляем пробелы в начале и конце
              line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              # Пропускаем пустые строки после обработки
              [ -z "$line" ] && continue
              # Проверяем, что строка содержит знак равенства
              if echo "$line" | grep -q '='; then
                # Экспортируем переменную (игнорируем ошибки для некорректных строк)
                if export "$line" 2>/dev/null; then
                  loaded_count=$((loaded_count + 1))
                else
                  echo "WARNING: Failed to load line from .env: ${line:0:50}..."
                fi
              else
                echo "WARNING: Skipping invalid line in .env (no '=' found): ${line:0:50}..."
              fi
            done < .env
            set +a
            echo "Loaded $loaded_count environment variables from .env file"
            
            # Проверка переменных окружения
            echo "Checking environment variables..."
            if [ -z "$DOCKERHUB_USERNAME" ]; then
              echo "ERROR: DOCKERHUB_USERNAME not set in .env file!"
              exit 1
            fi
            if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
              echo "WARNING: NEXT_PUBLIC_SUPABASE_URL not set in .env file!"
            fi
            if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
              echo "WARNING: NEXT_PUBLIC_SUPABASE_ANON_KEY not set in .env file!"
            fi
            echo "DOCKERHUB_USERNAME: $DOCKERHUB_USERNAME"
            
            # Удаление старого образа для принудительного обновления
            echo "Removing old image to force update..."
            docker rmi ${DOCKERHUB_USERNAME}/bartech:latest 2>/dev/null || true
            
            # Обновление образов (принудительно, игнорируя локальный кеш)
            echo "Pulling latest images..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull --ignore-pull-failures
            
            # Принудительный pull образа напрямую
            echo "Force pulling image directly..."
            docker pull ${DOCKERHUB_USERNAME}/bartech:latest || {
              echo "ERROR: Failed to pull image ${DOCKERHUB_USERNAME}/bartech:latest"
              echo "Available images:"
              docker images | grep bartech || echo "No bartech images found"
              exit 1
            }
            
            # Проверка, что образ был загружен
            if ! docker images | grep -q "${DOCKERHUB_USERNAME}/bartech.*latest"; then
              echo "ERROR: Failed to pull image ${DOCKERHUB_USERNAME}/bartech:latest"
              echo "Available images:"
              docker images | grep bartech || echo "No bartech images found"
              exit 1
            fi
            echo "Image pulled successfully: ${DOCKERHUB_USERNAME}/bartech:latest"
            
            # Показываем информацию об образе для отладки
            echo "Image details:"
            docker images ${DOCKERHUB_USERNAME}/bartech:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.CreatedAt}}"
            
            # Остановка старых контейнеров
            echo "Stopping old containers..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            
            # Удаление старых контейнеров для гарантии чистого запуска
            echo "Removing old containers..."
            docker rm -f bartech-nextjs bartech-nginx bartech-certbot 2>/dev/null || true
            
            # Запуск новых контейнеров (без кеша, принудительно пересоздавая)
            echo "Starting containers with --force-recreate..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate --remove-orphans
            
            # Ожидание запуска контейнеров
            echo "Waiting for containers to start..."
            sleep 5
            
            # Проверка статуса контейнеров
            echo "Checking container status..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
            
            # Ожидание готовности Next.js (проверка health check)
            echo "Waiting for Next.js to be ready..."
            max_attempts=30
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              if docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T nextjs node -e "require('http').get('http://127.0.0.1:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" 2>/dev/null; then
                echo "Next.js is ready!"
                break
              fi
              attempt=$((attempt + 1))
              echo "Attempt $attempt/$max_attempts: Next.js not ready yet, waiting..."
              sleep 2
            done
            
            if [ $attempt -eq $max_attempts ]; then
              echo "ERROR: Next.js failed to start after $max_attempts attempts"
              echo "Next.js logs:"
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs nextjs --tail=50
              exit 1
            fi
            
            # Перезагрузка Nginx после готовности Next.js
            echo "Reloading Nginx..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T nginx nginx -s reload || true
            
            # Очистка старых образов
            echo "Cleaning up old images..."
            docker image prune -f
            
            echo "Deployment completed successfully!"
          EOF

      - name: Health check
        run: |
          echo "Waiting for application to be fully ready..."
          sleep 15
          
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f https://technobar.by/api/health; then
              echo "Health check passed!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Health check attempt $attempt/$max_attempts failed, retrying..."
            sleep 5
          done
          
          echo "ERROR: Health check failed after $max_attempts attempts"
          ssh "$SSH_USER@$SERVER_HOST" << 'EOF'
            cd /opt/bartech
            echo "=== Container Status ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
            echo "=== Next.js Logs ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs nextjs --tail=50
            echo "=== Nginx Logs ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs nginx --tail=50
          EOF
          exit 1

